rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function
    function isSignedIn() {
      return request.auth != null;
    }

    // --- COLLECTION GROUP QUERIES ---
    match /{path=**}/trips/{tripId} {
      allow read: if isSignedIn() && resource.data.visibility == 'public';
    }
    match /{path=**}/entries/{entryId} {
      allow read: if isSignedIn() && resource.data.authorId == request.auth.uid;
    }

    // --- DOCUMENT SPECIFIC RULES ---

    // Users: Public Read (for Profiles), Owner Write
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
      
      match /trips/{tripId} {
        function isOwner() { return request.auth.uid == userId; }
        allow update, delete: if isSignedIn() && isOwner();
        allow create: if isSignedIn() && isOwner();
        allow read: if isSignedIn() && (
          isOwner() || 
          resource.data.visibility == 'public' ||
          (resource.data.sharedWith.hasAny([request.auth.uid]))
        );
        match /entries/{entryId} {
           // Allow owner AND shared users to read/write entries
           // We verify shared status by checking the parent trip document
           allow read, write: if isSignedIn() && (
             isOwner() || 
             get(/databases/$(database)/documents/users/$(userId)/trips/$(tripId)).data.sharedWith.hasAny([request.auth.uid])
           );
        }
      }
    }
    
    // Utilities
    match /routes/{routeId} { allow read, write: if isSignedIn(); }
    match /comments/{commentId} { allow read, write: if isSignedIn(); }

    // --- SOCIAL FEATURES (Stories & Reels) ---
    
    // Stories
    match /stories/{storyId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      // Allow author to delete/edit text, BUT allow anyone (authenticated) to update 'likes'
      // Simplified: Allow update if signed in. 
      allow update: if isSignedIn(); 
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      
      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update, delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || get(/databases/$(database)/documents/stories/$(storyId)).data.authorId == request.auth.uid);
      }
    }

    // Reels
    match /reels/{reelId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      // Allow update for Likes (anyone signed in)
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;

      match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update, delete: if isSignedIn() && (resource.data.authorId == request.auth.uid || get(/databases/$(database)/documents/reels/$(reelId)).data.authorId == request.auth.uid);
      }
    }

    // Notifications
    match /notifications/{notificationId} {
      // Allow authenticated users to read notifications
      // The query filters by userId on the client side
      allow read: if isSignedIn();
      // Anyone can create notifications (when they like/comment/follow)
      allow create: if isSignedIn();
      // Users can update their own notifications (mark as read)
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Users can delete their own notifications
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}